<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Notifications Push - E-r√©ussite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #1a202c;
      margin-bottom: 8px;
      font-size: 28px;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .status-card {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      border-left: 4px solid #4299e1;
    }

    .status-card.error {
      border-left-color: #f56565;
      background: #fff5f5;
    }

    .status-card.success {
      border-left-color: #48bb78;
      background: #f0fff4;
    }

    .status-card h3 {
      color: #2d3748;
      margin-bottom: 12px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      color: #4a5568;
      font-weight: 500;
    }

    .status-value {
      color: #2d3748;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .status-value.true {
      color: #48bb78;
      font-weight: bold;
    }

    .status-value.false {
      color: #f56565;
      font-weight: bold;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    button {
      background: #4299e1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: #3182ce;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }

    button.success {
      background: #48bb78;
    }

    button.success:hover {
      background: #38a169;
    }

    button.danger {
      background: #f56565;
    }

    button.danger:hover {
      background: #e53e3e;
    }

    .log-container {
      background: #1a202c;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      color: #e2e8f0;
      padding: 4px 0;
      line-height: 1.6;
    }

    .log-entry.info {
      color: #63b3ed;
    }

    .log-entry.success {
      color: #68d391;
    }

    .log-entry.error {
      color: #fc8181;
    }

    .log-entry.warning {
      color: #f6ad55;
    }

    .icon {
      display: inline-block;
      width: 20px;
      height: 20px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alert {
      background: #fef5e7;
      border: 1px solid #f39c12;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      color: #7d6608;
      font-size: 14px;
    }

    .alert strong {
      display: block;
      margin-bottom: 8px;
      color: #6c5214;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîî Test Notifications Push</h1>
    <p class="subtitle">Diagnostic complet pour E-r√©ussite</p>

    <div class="alert">
      <strong>üìã Instructions :</strong>
      Cliquez sur "Lancer le diagnostic" pour v√©rifier votre configuration. Ensuite, testez les boutons de notification.
    </div>

    <!-- Status Cards -->
    <div id="diagnosticResults"></div>

    <!-- Action Buttons -->
    <div class="button-group">
      <button id="btnDiagnostic" onclick="runDiagnostic()">
        üîç Lancer le diagnostic
      </button>
      <button id="btnPermission" onclick="requestPermission()" disabled>
        üîì Demander permission
      </button>
      <button id="btnTestNotif" onclick="testNotification()" class="success" disabled>
        üîî Tester notification
      </button>
      <button id="btnSubscribe" onclick="testSubscription()" disabled>
        üì± Test abonnement complet
      </button>
      <button id="btnClear" onclick="clearLogs()" class="danger">
        üóëÔ∏è Effacer logs
      </button>
    </div>

    <!-- Logs -->
    <div class="log-container" id="logs"></div>
  </div>

  <script>
    const logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logs.push({ timestamp, message, type });
      
      const logContainer = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      logs.length = 0;
      log('Logs effac√©s', 'info');
    }

    async function runDiagnostic() {
      const resultsDiv = document.getElementById('diagnosticResults');
      resultsDiv.innerHTML = '';
      clearLogs();
      
      log('=== D√âBUT DU DIAGNOSTIC ===', 'info');

      // 1. Support API
      log('V√©rification du support des APIs...', 'info');
      const support = {
        notification: 'Notification' in window,
        serviceWorker: 'serviceWorker' in navigator,
        pushManager: 'PushManager' in window
      };
      
      const supportCard = createStatusCard('1. Support des APIs', support.notification && support.serviceWorker && support.pushManager ? 'success' : 'error');
      supportCard.innerHTML += `
        <div class="status-item">
          <span class="status-label">Notification API</span>
          <span class="status-value ${support.notification}">${support.notification ? '‚úÖ Support√©e' : '‚ùå Non support√©e'}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Service Worker</span>
          <span class="status-value ${support.serviceWorker}">${support.serviceWorker ? '‚úÖ Support√©' : '‚ùå Non support√©'}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Push Manager</span>
          <span class="status-value ${support.pushManager}">${support.pushManager ? '‚úÖ Support√©' : '‚ùå Non support√©'}</span>
        </div>
      `;
      resultsDiv.appendChild(supportCard);
      log(`Notification API: ${support.notification}`, support.notification ? 'success' : 'error');
      log(`Service Worker: ${support.serviceWorker}`, support.serviceWorker ? 'success' : 'error');
      log(`Push Manager: ${support.pushManager}`, support.pushManager ? 'success' : 'error');

      // 2. Permission
      log('V√©rification de la permission...', 'info');
      const permission = Notification.permission;
      const permCard = createStatusCard('2. Permission Notifications', permission === 'granted' ? 'success' : 'error');
      permCard.innerHTML += `
        <div class="status-item">
          <span class="status-label">√âtat actuel</span>
          <span class="status-value">${permission === 'granted' ? '‚úÖ Accord√©e' : permission === 'denied' ? '‚ùå Refus√©e' : '‚ö†Ô∏è Non demand√©e'}</span>
        </div>
      `;
      resultsDiv.appendChild(permCard);
      log(`Permission: ${permission}`, permission === 'granted' ? 'success' : 'warning');

      // 3. Service Worker
      log('V√©rification du Service Worker...', 'info');
      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        const swCard = createStatusCard('3. Service Worker', regs.length > 0 ? 'success' : 'error');
        
        if (regs.length > 0) {
          const reg = regs[0];
          swCard.innerHTML += `
            <div class="status-item">
              <span class="status-label">Enregistr√©</span>
              <span class="status-value true">‚úÖ Oui</span>
            </div>
            <div class="status-item">
              <span class="status-label">URL</span>
              <span class="status-value">${reg.active?.scriptURL || 'N/A'}</span>
            </div>
            <div class="status-item">
              <span class="status-label">√âtat</span>
              <span class="status-value">${reg.active?.state || 'N/A'}</span>
            </div>
          `;
          log(`Service Worker trouv√©: ${reg.active?.scriptURL}`, 'success');
          log(`√âtat: ${reg.active?.state}`, 'success');
        } else {
          swCard.innerHTML += `
            <div class="status-item">
              <span class="status-label">Enregistr√©</span>
              <span class="status-value false">‚ùå Aucun Service Worker trouv√©</span>
            </div>
          `;
          log('‚ùå ERREUR: Aucun Service Worker enregistr√© !', 'error');
          log('Le fichier sw.js doit √™tre enregistr√© dans main.jsx', 'warning');
        }
        resultsDiv.appendChild(swCard);
      } catch (error) {
        log(`Erreur Service Worker: ${error.message}`, 'error');
      }

      // 4. VAPID Key (simul√© car on ne peut pas acc√©der √† import.meta.env ici)
      log('V√©rification de la cl√© VAPID...', 'info');
      const vapidCard = createStatusCard('4. Cl√© VAPID', 'success');
      vapidCard.innerHTML += `
        <div class="status-item">
          <span class="status-label">Configuration</span>
          <span class="status-value">‚ö†Ô∏è √Ä v√©rifier dans l'application React</span>
        </div>
        <div class="status-item">
          <span class="status-label">Fichier .env.local</span>
          <span class="status-value">Doit contenir VITE_VAPID_PUBLIC_KEY</span>
        </div>
      `;
      resultsDiv.appendChild(vapidCard);
      log('Note: La cl√© VAPID sera v√©rifi√©e lors de l\'abonnement', 'warning');

      // 5. Environnement
      log('V√©rification de l\'environnement...', 'info');
      const envCard = createStatusCard('5. Environnement', window.location.protocol === 'http:' || window.location.protocol === 'https:' ? 'success' : 'error');
      envCard.innerHTML += `
        <div class="status-item">
          <span class="status-label">Protocole</span>
          <span class="status-value">${window.location.protocol}</span>
        </div>
        <div class="status-item">
          <span class="status-label">H√¥te</span>
          <span class="status-value">${window.location.host}</span>
        </div>
        <div class="status-item">
          <span class="status-label">URL compl√®te</span>
          <span class="status-value">${window.location.href}</span>
        </div>
      `;
      resultsDiv.appendChild(envCard);
      log(`Protocole: ${window.location.protocol}`, 'info');
      log(`H√¥te: ${window.location.host}`, 'info');

      // Enable buttons
      log('=== FIN DU DIAGNOSTIC ===', 'info');
      log('‚úÖ Vous pouvez maintenant tester les boutons ci-dessus', 'success');
      
      document.getElementById('btnPermission').disabled = false;
      if (permission === 'granted') {
        document.getElementById('btnTestNotif').disabled = false;
        document.getElementById('btnSubscribe').disabled = false;
      }
    }

    async function requestPermission() {
      log('Demande de permission...', 'info');
      try {
        const permission = await Notification.requestPermission();
        log(`R√©sultat: ${permission}`, permission === 'granted' ? 'success' : 'error');
        
        if (permission === 'granted') {
          log('‚úÖ Permission accord√©e !', 'success');
          document.getElementById('btnTestNotif').disabled = false;
          document.getElementById('btnSubscribe').disabled = false;
        } else if (permission === 'denied') {
          log('‚ùå Permission refus√©e', 'error');
          log('Allez dans les param√®tres du navigateur pour autoriser les notifications', 'warning');
        } else {
          log('‚ö†Ô∏è Permission non d√©finie', 'warning');
        }
        
        // Refresh diagnostic
        await runDiagnostic();
      } catch (error) {
        log(`Erreur: ${error.message}`, 'error');
      }
    }

    async function testNotification() {
      log('Test de notification simple...', 'info');
      try {
        if (Notification.permission !== 'granted') {
          log('‚ùå Permission non accord√©e', 'error');
          return;
        }

        const notification = new Notification('üéâ E-r√©ussite', {
          body: 'Test r√©ussi ! Les notifications fonctionnent correctement.',
          icon: '/icon-192x192.png',
          badge: '/icon-192x192.png',
          tag: 'test',
          requireInteraction: false
        });

        log('‚úÖ Notification envoy√©e !', 'success');
        
        notification.onclick = () => {
          log('Notification cliqu√©e', 'info');
          notification.close();
        };
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function testSubscription() {
      log('Test d\'abonnement push complet...', 'info');
      try {
        // 1. Get Service Worker
        log('R√©cup√©ration du Service Worker...', 'info');
        const registration = await navigator.serviceWorker.ready;
        log('‚úÖ Service Worker pr√™t', 'success');

        // 2. Check for existing subscription
        log('V√©rification d\'un abonnement existant...', 'info');
        let subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          log('‚úÖ Abonnement existant trouv√©', 'success');
          log(`Endpoint: ${subscription.endpoint.substring(0, 50)}...`, 'info');
        } else {
          log('‚ö†Ô∏è Pas d\'abonnement existant', 'warning');
          log('Note: La cl√© VAPID est requise pour cr√©er un abonnement', 'warning');
          log('Cela doit √™tre fait depuis l\'application React avec import.meta.env.VITE_VAPID_PUBLIC_KEY', 'info');
        }

        // 3. Test notification via Service Worker
        log('Test de notification via Service Worker...', 'info');
        await registration.showNotification('üîî E-r√©ussite - Service Worker', {
          body: 'Cette notification vient du Service Worker !',
          icon: '/icon-192x192.png',
          badge: '/icon-192x192.png',
          tag: 'sw-test',
          vibrate: [200, 100, 200]
        });
        log('‚úÖ Notification via Service Worker envoy√©e !', 'success');

      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('D√©tails:', error);
      }
    }

    function createStatusCard(title, status = 'default') {
      const card = document.createElement('div');
      card.className = `status-card ${status}`;
      
      const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      card.innerHTML = `<h3>${icon} ${title}</h3>`;
      
      return card;
    }

    // Auto-run diagnostic on load
    window.addEventListener('load', () => {
      log('Page charg√©e. Cliquez sur "Lancer le diagnostic" pour commencer.', 'info');
    });
  </script>
</body>
</html>
