import{r as e,j as s}from"./vendor-react-470eca1f.js";import{H as a}from"./Helmet-2c7e73f6.js";import{N as t}from"./Navbar-fef78110.js";import{e as r,s as l,C as i,c as d,B as n,q as c}from"./index-80385b81.js";import{I as o}from"./input-5c98a0d4.js";import{B as m}from"./badge-3c6eba89.js";import{c as x}from"./vendor-router-da2b77bd.js";import{m as p,A as h}from"./vendor-charts-0ffd78b1.js";import{az as u,c as g,g as b,f as j,z as f,A as _,J as y,Z as v,a0 as N,p as w,X as k,x as z,ao as q,aI as C,ax as $,C as S,$ as A}from"./vendor-ui-297a683c.js";import"./vendor-supabase-1d8f37f5.js";const I=e=>{const s=new Date-new Date(e),a=Math.floor(s/1e3),t=Math.floor(a/60),r=Math.floor(t/60),l=Math.floor(r/24);if(a<60)return"À l'instant";if(t<60)return`Il y a ${t} min`;if(r<24){const e=t%60;return e>0?`Il y a ${r}h${e.toString().padStart(2,"0")}`:`Il y a ${r}h`}if(l<7)return`Il y a ${l} jour${l>1?"s":""}`;if(l<30){const e=Math.floor(l/7);return`Il y a ${e} semaine${e>1?"s":""}`}if(l<365){return`Il y a ${Math.floor(l/30)} mois`}{const e=Math.floor(l/365);return`Il y a ${e} an${e>1?"s":""}`}},E=e=>({chapter_completed:"Chapitre complété",quiz_completed:"Quiz réalisé",exam_completed:"Examen réalisé",badge_earned:"Badge obtenu",level_up:"Niveau supérieur"}[e]||"Activité"),M=()=>{const{user:M,userProfile:D,loading:P}=r(),Q=x(),[R,B]=e.useState([]),[F,H]=e.useState([]),[L,T]=e.useState(!0),[U,J]=e.useState(""),[V,W]=e.useState("all"),[Z,G]=e.useState(!1),[K,O]=e.useState(null),[X,Y]=e.useState(null),[ee,se]=e.useState(!1),[ae,te]=e.useState({totalActivities:0,chaptersCompleted:0,quizzesCompleted:0,examsCompleted:0});e.useEffect(()=>{P||M||Q("/login"),M&&D&&re()},[M,D,P,Q]),e.useEffect(()=>{le()},[R,U,V]);const re=async()=>{T(!0);try{const e=[],{data:s}=await l.from("user_progress").select("\n          id,\n          chapitre_id,\n          completed_at,\n          time_spent,\n          chapitres:chapitre_id (\n            id,\n            title,\n            matieres:matiere_id (name)\n          )\n        ").eq("user_id",M.id).eq("completed",!0).order("completed_at",{ascending:!1});s&&s.forEach(s=>{var a;s.chapitres&&e.push({id:`chapter-${s.id}`,type:"chapter_completed",title:s.chapitres.title,subject:(null==(a=s.chapitres.matieres)?void 0:a.name)||"Matière",timestamp:s.completed_at,timeSpent:s.time_spent,detailsUrl:"/courses",data:s})});const{data:a}=await l.from("quiz_results").select("\n          id,\n          quiz_id,\n          score,\n          correct_answers,\n          total_questions,\n          time_taken,\n          completed_at,\n          answers,\n          quiz:quiz_id (\n            id,\n            title,\n            chapitres:chapitre_id (\n              matieres:matiere_id (name)\n            )\n          )\n        ").eq("user_id",M.id).order("completed_at",{ascending:!1});a&&a.forEach(s=>{var a,t;s.quiz&&e.push({id:`quiz-${s.id}`,type:"quiz_completed",title:s.quiz.title,subject:(null==(t=null==(a=s.quiz.chapitres)?void 0:a.matieres)?void 0:t.name)||"Matière",score:s.score,correctAnswers:s.correct_answers,totalQuestions:s.total_questions,timestamp:s.completed_at,timeSpent:s.time_taken,detailsUrl:`/activity/quiz/${s.id}`,data:s})});const{data:t}=await l.from("exam_results").select("\n          id,\n          exam_id,\n          score,\n          time_taken,\n          completed_at,\n          answers,\n          examens:exam_id (\n            id,\n            title,\n            difficulty,\n            type,\n            matieres:matiere_id (name)\n          )\n        ").eq("user_id",M.id).order("completed_at",{ascending:!1});t&&t.forEach(s=>{var a;s.examens&&e.push({id:`exam-${s.id}`,type:"exam_completed",title:s.examens.title,subject:(null==(a=s.examens.matieres)?void 0:a.name)||"blanc"===s.examens.type?"Examen blanc":"Examen",score:s.score,difficulty:s.examens.difficulty,timestamp:s.completed_at,timeSpent:s.time_taken,detailsUrl:`/activity/exam/${s.id}`,data:s})});const{data:r}=await l.from("user_badges").select("\n          id,\n          earned_at,\n          badge_id,\n          badges!inner (\n            badge_id,\n            name,\n            icon_name,\n            description\n          )\n        ").eq("user_id",M.id).order("earned_at",{ascending:!1}),i=(null==r?void 0:r.map(e=>({id:e.id,badge_id:e.badge_id,badge_name:e.badges.name,badge_description:e.badges.description,badge_icon:e.badges.icon_name,earned_at:e.earned_at})))||[];i&&i.length>0&&i.forEach(s=>{e.push({id:`badge-${s.id}`,type:"badge_earned",title:s.badge_name,description:s.badge_description,icon:s.badge_icon,timestamp:s.earned_at,detailsUrl:"/profile",data:s})}),e.sort((e,s)=>new Date(s.timestamp)-new Date(e.timestamp)),B(e),te({totalActivities:e.length,chaptersCompleted:e.filter(e=>"chapter_completed"===e.type).length,quizzesCompleted:e.filter(e=>"quiz_completed"===e.type).length,examsCompleted:e.filter(e=>"exam_completed"===e.type).length})}catch(e){}finally{T(!1)}},le=()=>{let e=[...R];if("all"!==V&&(e=e.filter(e=>e.type===V)),U.trim()){const s=U.toLowerCase();e=e.filter(e=>e.title.toLowerCase().includes(s)||e.subject.toLowerCase().includes(s))}H(e)};return P||L?s.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50",children:[s.jsx(t,{}),s.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12",children:s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})})]}):s.jsxs(s.Fragment,{children:[s.jsx(a,{children:s.jsx("title",{children:"Historique des Activités - E-Réussite"})}),s.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900",children:[s.jsx(t,{}),s.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[s.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-8",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Historique des Activités"}),s.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Consultez toutes vos activités d'apprentissage"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8",children:[s.jsx(i,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Total"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:ae.totalActivities})]}),s.jsx(u,{className:"w-8 h-8 text-blue-600"})]})})}),s.jsx(i,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Chapitres"}),s.jsx("p",{className:"text-2xl font-bold text-blue-600",children:ae.chaptersCompleted})]}),s.jsx(g,{className:"w-8 h-8 text-blue-600"})]})})}),s.jsx(i,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Quiz"}),s.jsx("p",{className:"text-2xl font-bold text-green-600",children:ae.quizzesCompleted})]}),s.jsx(b,{className:"w-8 h-8 text-green-600"})]})})}),s.jsx(i,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Examens"}),s.jsx("p",{className:"text-2xl font-bold text-purple-600",children:ae.examsCompleted})]}),s.jsx(j,{className:"w-8 h-8 text-purple-600"})]})})})]}),s.jsx(i,{className:"mb-6 dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:s.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx(f,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),s.jsx(o,{type:"text",placeholder:"Rechercher une activité...",value:U,onChange:e=>J(e.target.value),className:"pl-10"})]})}),s.jsxs("div",{className:"flex gap-2 flex-wrap",children:[s.jsx(n,{variant:"all"===V?"default":"outline",size:"sm",onClick:()=>W("all"),children:"Tout"}),s.jsxs(n,{variant:"chapter_completed"===V?"default":"outline",size:"sm",onClick:()=>W("chapter_completed"),children:[s.jsx(g,{className:"w-4 h-4 mr-1"}),"Chapitres"]}),s.jsxs(n,{variant:"quiz_completed"===V?"default":"outline",size:"sm",onClick:()=>W("quiz_completed"),children:[s.jsx(b,{className:"w-4 h-4 mr-1"}),"Quiz"]}),s.jsxs(n,{variant:"exam_completed"===V?"default":"outline",size:"sm",onClick:()=>W("exam_completed"),children:[s.jsx(j,{className:"w-4 h-4 mr-1"}),"Examens"]}),s.jsxs(n,{variant:"badge_earned"===V?"default":"outline",size:"sm",onClick:()=>W("badge_earned"),children:[s.jsx(_,{className:"w-4 h-4 mr-1"}),"Badges"]})]})]})})}),s.jsx(i,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(d,{className:"p-6",children:0===F.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(y,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-500",children:U||"all"!==V?"Aucune activité trouvée avec ces filtres":"Aucune activité pour le moment"})]}):s.jsx("div",{className:"space-y-3",children:s.jsx(h,{children:F.map((e,a)=>{const t=(r=e.type,{chapter_completed:g,quiz_completed:b,exam_completed:j,badge_earned:_,level_up:v}[r]||g);var r;const i=(e=>({chapter_completed:"blue",quiz_completed:"green",exam_completed:"purple",badge_earned:"yellow",level_up:"orange"}[e]||"gray"))(e.type);return s.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,x:-20},transition:{delay:.05*a},className:"relative p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 hover:shadow-lg transition-all",children:[s.jsx("div",{className:"absolute top-4 right-4",children:s.jsx(m,{variant:"secondary",className:"text-xs",children:E(e.type)})}),s.jsxs("div",{className:"flex items-start gap-4",children:[s.jsx("div",{className:`p-3 rounded-xl bg-${i}-100 shrink-0`,children:s.jsx(t,{className:`w-7 h-7 text-${i}-600`})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-900 dark:text-white mb-2 truncate",children:e.title}),s.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-300 mb-3",children:[s.jsx("span",{className:"font-medium",children:e.subject}),s.jsx("span",{children:"•"}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(y,{className:"w-4 h-4"}),I(e.timestamp)]}),e.timeSpent&&s.jsxs(s.Fragment,{children:[s.jsx("span",{children:"•"}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(v,{className:"w-4 h-4"}),Math.round(e.timeSpent/60)," min"]})]})]}),void 0!==e.score&&s.jsxs("div",{className:"flex items-center gap-4 mb-3",children:[s.jsx("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg "+(e.score>=70?"bg-green-100":e.score>=50?"bg-yellow-100":"bg-red-100"),children:s.jsxs("span",{className:"text-sm font-bold "+(e.score>=70?"text-green-700":e.score>=50?"text-yellow-700":"text-red-700"),children:["Score: ",e.score,"%"]})}),void 0!==e.correctAnswers&&e.totalQuestions&&s.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-300",children:[e.correctAnswers,"/",e.totalQuestions," correctes"]})]}),s.jsx("p",{className:"text-xs text-gray-500",children:(d=e.timestamp,new Date(d).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}))})]})]}),s.jsx("div",{className:"absolute bottom-4 right-4",children:s.jsxs(n,{onClick:s=>(async(e,s)=>{var a,t,r,i,d,n;s.stopPropagation(),O(e),G(!0),se(!0),Y(null);try{let s=[];if("quiz_completed"===e.type&&(null==(t=null==(a=e.data)?void 0:a.quiz)?void 0:t.chapitre_id)){const{data:a}=await l.from("chapitres").select("id, title, matiere_id, matieres:matiere_id(name)").eq("id",e.data.quiz.chapitre_id).single();a&&s.push({id:a.id,title:a.title,matiere_id:a.matiere_id,matiere:null==(r=a.matieres)?void 0:r.name})}else if("exam_completed"===e.type&&(null==(d=null==(i=e.data)?void 0:i.examens)?void 0:d.matiere_id)){const{data:a}=await l.from("chapitres").select("id, title, matiere_id").eq("matiere_id",e.data.examens.matiere_id).order("ordre");a&&(s=a.map(e=>({id:e.id,title:e.title,matiere_id:e.matiere_id})))}else if("chapter_completed"===e.type&&(null==(n=e.data)?void 0:n.chapitre_id)){const{data:a}=await l.from("chapitres").select("id, title, matiere_id").eq("id",e.data.chapitre_id).single();a&&s.push({id:a.id,title:a.title,matiere_id:a.matiere_id})}const o=await c(e,D,s);Y(o)}catch(o){Y({error:!0,message:"Impossible de générer les conseils pour le moment."})}finally{se(!1)}})(e,s),size:"sm",className:"gap-2 bg-gradient-to-r from-yellow-400 via-orange-400 to-yellow-500 hover:from-yellow-500 hover:via-orange-500 hover:to-yellow-600 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300 border-0 group",children:[s.jsx(N,{className:"w-4 h-4 animate-pulse group-hover:animate-bounce"}),"Conseils"]})})]},e.id);var d})})})})})]})]}),s.jsx(h,{children:Z&&s.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:()=>G(!1),children:s.jsxs(p.div,{initial:{scale:.9,y:20},animate:{scale:1,y:0},exit:{scale:.9,y:20},onClick:e=>e.stopPropagation(),className:"bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-hidden flex flex-col",children:[s.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-700 dark:to-purple-700 p-6 text-white flex-shrink-0",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(w,{className:"w-8 h-8"}),s.jsx("h2",{className:"text-2xl font-bold",children:"Conseils Personnalisés"})]}),s.jsx("button",{onClick:()=>G(!1),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",children:s.jsx(k,{className:"w-6 h-6"})})]}),K&&s.jsxs("p",{className:"text-blue-100 text-sm",children:[K.title," • ",K.subject]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:ee?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"}),s.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Analyse en cours par l'IA..."})]}):(null==X?void 0:X.error)?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx(z,{className:"w-16 h-16 text-red-400 mb-4"}),s.jsx("p",{className:"text-red-600 text-center",children:X.message})]}):X?s.jsxs("div",{className:"space-y-6",children:[X.strengths&&X.strengths.length>0&&s.jsxs("div",{className:"bg-green-50 rounded-xl p-5 border-2 border-green-200",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s.jsx(q,{className:"w-6 h-6 text-green-600"}),s.jsx("h3",{className:"text-lg font-bold text-green-900",children:"Points Forts"})]}),s.jsx("ul",{className:"space-y-2",children:X.strengths.map((e,a)=>s.jsxs("li",{className:"flex items-start gap-2 text-green-800",children:[s.jsx(C,{className:"w-5 h-5 mt-0.5 shrink-0"}),s.jsx("span",{children:e})]},a))})]}),X.weaknesses&&X.weaknesses.length>0&&s.jsxs("div",{className:"bg-orange-50 rounded-xl p-5 border-2 border-orange-200",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s.jsx($,{className:"w-6 h-6 text-orange-600"}),s.jsx("h3",{className:"text-lg font-bold text-orange-900",children:"Points à Améliorer"})]}),s.jsx("ul",{className:"space-y-2",children:X.weaknesses.map((e,a)=>s.jsxs("li",{className:"flex items-start gap-2 text-orange-800",children:[s.jsx(z,{className:"w-5 h-5 mt-0.5 shrink-0"}),s.jsx("span",{children:e})]},a))})]}),X.suggestions&&X.suggestions.length>0&&s.jsxs("div",{className:"bg-blue-50 rounded-xl p-5 border-2 border-blue-200",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s.jsx(N,{className:"w-6 h-6 text-blue-600"}),s.jsx("h3",{className:"text-lg font-bold text-blue-900",children:"Conseils pour Réussir"})]}),s.jsx("ul",{className:"space-y-3",children:X.suggestions.map((e,a)=>{const t="string"==typeof e?e:e.text,r="object"==typeof e?e.chapterId:null,l="object"==typeof e?e.chapterTitle:null,i="object"==typeof e?e.matiereId:null,d=null!=r&&null!=i;return s.jsxs("li",{className:"flex items-start gap-2",children:[s.jsx("span",{className:"flex items-center justify-center w-6 h-6 rounded-full bg-blue-200 text-blue-900 font-bold text-sm mt-0.5 shrink-0",children:a+1}),s.jsxs("div",{className:"flex-1",children:[s.jsx("span",{className:"text-blue-800",children:t}),d&&s.jsxs("button",{onClick:()=>{G(!1),Q(`/course/${i}?chapter=${r}`)},className:"ml-2 inline-flex items-center gap-1 px-3 py-1 mt-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm",children:[s.jsx(g,{className:"w-3.5 h-3.5"}),s.jsx("span",{children:l||"Voir le chapitre"}),s.jsx(S,{className:"w-3.5 h-3.5"})]})]})]},a)})})]}),X.message&&s.jsx("div",{className:"bg-purple-50 rounded-xl p-5 border-2 border-purple-200",children:s.jsx("p",{className:"text-purple-900 leading-relaxed",children:X.message})})]}):null}),!ee&&!(null==X?void 0:X.error)&&X&&s.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-slate-700 flex-shrink-0",children:s.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[s.jsxs(n,{onClick:()=>{if(G(!1),"quiz_completed"===K.type){const e=K.data.chapitre_id;Q(e?`/chapitre/${e}`:"/my-courses")}else if("exam_completed"===K.type){const e=K.data.matiere_id;Q(e?`/my-courses?matiere=${e}`:"/my-courses")}else if("chapter_completed"===K.type){const e=K.data.chapitre_id;Q(e?`/chapitre/${e}`:"/my-courses")}else Q("/my-courses")},variant:"outline",className:"flex-1 gap-2 text-base py-5 border-2 border-blue-600 dark:border-blue-500 text-blue-700 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 shadow-md font-semibold",children:[s.jsx(g,{className:"w-5 h-5"}),"Reprendre le cours"]}),s.jsxs(n,{onClick:()=>{G(!1),"quiz_completed"===K.type?Q(`/quiz/${K.data.quiz_id}`):"exam_completed"===K.type?Q(`/exam/${K.data.exam_id}`):"chapter_completed"===K.type&&Q("/courses")},className:"flex-1 gap-2 text-base py-5 bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-700 dark:to-purple-700 hover:from-blue-700 hover:to-purple-700 dark:hover:from-blue-800 dark:hover:to-purple-800 shadow-lg",children:[s.jsx(A,{className:"w-5 h-5"}),"Recommencer l'activité"]})]})})]})})})]})};export{M as default};
