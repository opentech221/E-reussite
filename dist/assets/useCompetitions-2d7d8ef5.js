import{r as t}from"./vendor-react-470eca1f.js";import{s as e,e as r}from"./index-80385b81.js";const a=new class{async getCompetitions(t={}){try{let r=e.from("competitions").select("*").order("starts_at",{ascending:!0});t.status&&(r=r.eq("status",t.status)),t.subject&&(r=r.eq("subject",t.subject)),t.grade_level&&(r=r.eq("grade_level",t.grade_level)),t.type&&(r=r.eq("type",t.type));const{data:a,error:s}=await r;if(s)throw s;return{data:a,error:null}}catch(r){return{data:null,error:r}}}async getCompetitionById(t){try{const{data:r,error:a}=await e.from("competitions").select("*").eq("id",t).single();if(a)throw a;return{data:r,error:null}}catch(r){return{data:null,error:r}}}async joinCompetition(t,r){try{const{data:a,error:s}=await e.rpc("join_competition",{p_competition_id:t,p_user_id:r});if(s)throw s;if(!a.success)throw new Error(a.error||"Échec de l'inscription");return{data:a,error:null}}catch(a){return{data:null,error:a}}}async getCompetitionQuestions(t){try{const{data:r,error:a}=await e.from("competition_questions").select("\n          *,\n          question:questions(*)\n        ").eq("competition_id",t).order("order_index",{ascending:!0});if(a)throw a;return{data:r,error:null}}catch(r){return{data:null,error:r}}}async getParticipantData(t,r){try{const{data:a,error:s}=await e.from("competition_participants").select("*").eq("competition_id",t).eq("user_id",r).maybeSingle();if(s)throw s;return{data:a,error:null}}catch(a){return{data:null,error:a}}}async submitAnswer(t,r,a,s){try{const{data:n,error:o}=await e.rpc("submit_competition_answer",{p_participant_id:t,p_question_id:r,p_selected_answer:a,p_time_taken_seconds:s});if(o)throw o;if(!n.success)throw new Error("Échec de la soumission");return{data:n,error:null}}catch(n){return{data:null,error:n}}}async completeCompetition(t){try{const{data:r,error:a}=await e.rpc("complete_competition_participant",{p_participant_id:t});if(a)throw a;if(!r.success)throw new Error("Échec de la finalisation");return{data:r,error:null}}catch(r){return{data:null,error:r}}}async getLeaderboard(t,r="global",a=100){try{const{data:s,error:n}=await e.rpc("get_competition_leaderboard",{p_competition_id:t,p_scope:r,p_limit:a});if(n)throw n;return{data:s,error:null}}catch(s){return{data:null,error:s}}}subscribeToCompetition(t,r){return e.channel(`competition:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"competitions",filter:`id=eq.${t}`},t=>{r(t)}).subscribe()}subscribeToParticipants(t,r){return e.channel(`participants:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"competition_participants",filter:`competition_id=eq.${t}`},t=>{r(t)}).subscribe()}subscribeToLeaderboard(t,r){return e.channel(`leaderboard:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"competition_leaderboards",filter:`competition_id=eq.${t}`},t=>{r(t)}).subscribe()}async unsubscribe(t){t&&await e.removeChannel(t)}async getCompetitionStats(t){try{const{data:r,error:a}=await e.from("competition_participants").select("*").eq("user_id",t).eq("status","completed");if(a)throw a;const s=r.length,n=r.reduce((t,e)=>t+e.score,0),o=r.length>0?r.reduce((t,e)=>t+(e.rank||0),0)/r.length:0,i=r.filter(t=>t.rank<=3).length;return{data:{totalCompetitions:s,totalScore:n,avgRank:Math.round(o),topRanks:i},error:null}}catch(r){return{data:null,error:r}}}},s=(e=null)=>{const{user:s}=r(),[n,o]=t.useState([]),[i,c]=t.useState(null),[u,l]=t.useState(null),[d,p]=t.useState([]),[m,b]=t.useState([]),[_,w]=t.useState(null),[g,h]=t.useState(!1),[y,f]=t.useState(null),C=t.useCallback(async(t={})=>{h(!0),f(null);const{data:e,error:r}=await a.getCompetitions(t);r?f(r.message):o(e||[]),h(!1)},[]),v=t.useCallback(async t=>{h(!0),f(null);const{data:e,error:r}=await a.getCompetitionById(t);r?f(r.message):c(e),h(!1)},[]),q=t.useCallback(async t=>{if(!s)return f("Vous devez être connecté pour participer"),{success:!1};h(!0),f(null);const{data:e,error:r}=await a.joinCompetition(t,s.id);return r?(f(r.message),h(!1),{success:!1}):((null==e?void 0:e.participant_id)&&await k(t),h(!1),{success:!0,data:e})},[s]),k=t.useCallback(async t=>{if(!s)return;const{data:e,error:r}=await a.getParticipantData(t,s.id);r||l(e)},[s]),S=t.useCallback(async t=>{h(!0);const{data:e,error:r}=await a.getCompetitionQuestions(t);r?f(r.message):p(e||[]),h(!1)},[]),T=t.useCallback(async(t,e,r)=>{if(!u)return f("Données participant manquantes"),{success:!1};const{data:s,error:n}=await a.submitAnswer(u.id,t,e,r);return n?(f(n.message),{success:!1}):(l(t=>({...t,score:s.total_score,correct_answers:s.correct_answers,wrong_answers:s.wrong_answers})),{success:!0,data:s})},[u]),j=t.useCallback(async()=>{if(!u)return f("Données participant manquantes"),{success:!1};h(!0);const{data:t,error:e}=await a.completeCompetition(u.id);return e?(f(e.message),h(!1),{success:!1}):(l(e=>({...e,status:"completed",rank:t.rank})),h(!1),{success:!0,data:t})},[u]),E=t.useCallback(async(t,e="global",r=100)=>{const{data:s,error:n}=await a.getLeaderboard(t,e,r);n?f(n.message):b(s||[])},[]),P=t.useCallback(async()=>{if(!s)return;const{data:t,error:e}=await a.getCompetitionStats(s.id);e||w(t)},[s]);return t.useEffect(()=>{if(!e)return;let t,r,n;return(async()=>{t=a.subscribeToCompetition(e,t=>{"UPDATE"===t.eventType&&c(t.new)}),r=a.subscribeToParticipants(e,t=>{var e;(null==(e=t.new)?void 0:e.user_id)===(null==s?void 0:s.id)&&l(t.new),"INSERT"===t.eventType&&c(t=>t?{...t,current_participants:(t.current_participants||0)+1}:null)}),n=a.subscribeToLeaderboard(e,()=>{E(e)})})(),()=>{a.unsubscribe(t),a.unsubscribe(r),a.unsubscribe(n)}},[e,s,E]),t.useEffect(()=>{e&&(v(e),k(e),E(e))},[e,v,k,E]),{competitions:n,currentCompetition:i,participant:u,questions:d,leaderboard:m,stats:_,loading:g,error:y,loadCompetitions:C,loadCompetition:v,joinCompetition:q,loadQuestions:S,submitAnswer:T,completeCompetition:j,loadLeaderboard:E,loadStats:P,isRegistered:!!u,isCompleted:"completed"===(null==u?void 0:u.status),isInProgress:"in_progress"===(null==u?void 0:u.status),canJoin:"upcoming"===(null==i?void 0:i.status)||"active"===(null==i?void 0:i.status)}};export{s as u};
