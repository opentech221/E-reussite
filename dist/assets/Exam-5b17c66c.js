import{r as e,j as s}from"./vendor-react-470eca1f.js";import{H as t}from"./Helmet-2c7e73f6.js";import{d as a,k as i,u as r,e as l,s as n,C as o,c as d,a as c,b as m,B as x}from"./index-80385b81.js";import{P as h}from"./progress-d9418a6f.js";import{B as u}from"./badge-3c6eba89.js";import{b4 as p,b5 as b,b6 as f,b7 as j,b8 as g,b9 as w,ba as N,bb as v,bc as y,ap as _,b3 as k,a7 as S,aO as C,J as R,aR as q,C as E}from"./vendor-ui-297a683c.js";import{d as $,c as D}from"./vendor-router-da2b77bd.js";import{m as M,A as T}from"./vendor-charts-0ffd78b1.js";import"./vendor-supabase-1d8f37f5.js";const Q=N,z=v,A=y,I=e.forwardRef(({className:e,...t},i)=>s.jsx(p,{className:a("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...t,ref:i}));I.displayName=p.displayName;const O=e.forwardRef(({className:e,...t},i)=>s.jsxs(A,{children:[s.jsx(I,{}),s.jsx(b,{ref:i,className:a("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",e),...t})]}));O.displayName=b.displayName;const F=({className:e,...t})=>s.jsx("div",{className:a("flex flex-col space-y-2 text-center sm:text-left",e),...t});F.displayName="AlertDialogHeader";const P=({className:e,...t})=>s.jsx("div",{className:a("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...t});P.displayName="AlertDialogFooter";const B=e.forwardRef(({className:e,...t},i)=>s.jsx(f,{ref:i,className:a("text-lg font-semibold",e),...t}));B.displayName=f.displayName;const H=e.forwardRef(({className:e,...t},i)=>s.jsx(j,{ref:i,className:a("text-sm text-muted-foreground",e),...t}));H.displayName=j.displayName;const U=e.forwardRef(({className:e,...t},r)=>s.jsx(g,{ref:r,className:a(i(),e),...t}));U.displayName=g.displayName;const G=e.forwardRef(({className:e,...t},r)=>s.jsx(w,{ref:r,className:a(i({variant:"outline"}),"mt-2 sm:mt-0",e),...t}));G.displayName=w.displayName;const V=()=>{var a;const{examId:i}=$(),p=D(),{toast:b}=r(),{user:f}=l(),[j,g]=e.useState(null),[w,N]=e.useState([]),[v,y]=e.useState(0),[A,I]=e.useState({}),[V,J]=e.useState(0),[W,K]=e.useState(!0),[L,X]=e.useState(!1),[Y,Z]=e.useState(!1),[ee,se]=e.useState(null),[te,ae]=e.useState(null);e.useEffect(()=>{i&&ie()},[i]),e.useEffect(()=>{if(V<=0&&j&&!Y)le(!0);else if(V>0){const e=setInterval(()=>{J(e=>e-1)},1e3);return()=>clearInterval(e)}},[V,j,Y]);const ie=async()=>{try{K(!0);const{data:e,error:s}=await n.from("examens").select("\n          *,\n          matiere:matieres(id, name, level)\n        ").eq("id",i).single();if(s)throw s;if(!e)return b({title:"Examen non trouvé",variant:"destructive"}),void p("/exam");g(e),J(60*e.duration_minutes),ae(new Date);const t=re(e);N(t)}catch(e){b({variant:"destructive",title:"Erreur",description:"Impossible de charger l'examen"}),p("/exam")}finally{K(!1)}},re=e=>{var s,t,a,i;const r=[{id:1,question:`Question 1 - ${null==(s=e.matiere)?void 0:s.name}`,text:"Ceci est une question de démonstration. Dans un vrai examen, cette question serait liée au contenu du cours.",type:"multiple_choice",options:[{id:"a",text:"Réponse A"},{id:"b",text:"Réponse B"},{id:"c",text:"Réponse C"},{id:"d",text:"Réponse D"}],correct_answer:"b",points:5},{id:2,question:`Question 2 - ${null==(t=e.matiere)?void 0:t.name}`,text:"Deuxième question de démonstration avec options différentes.",type:"multiple_choice",options:[{id:"a",text:"Option 1"},{id:"b",text:"Option 2"},{id:"c",text:"Option 3"},{id:"d",text:"Option 4"}],correct_answer:"c",points:5},{id:3,question:`Question 3 - ${null==(a=e.matiere)?void 0:a.name}`,text:"Troisième question pour tester vos connaissances.",type:"multiple_choice",options:[{id:"a",text:"Première possibilité"},{id:"b",text:"Deuxième possibilité"},{id:"c",text:"Troisième possibilité"},{id:"d",text:"Quatrième possibilité"}],correct_answer:"a",points:5}],l=Math.max(5,Math.floor(e.duration_minutes/10)),n=[];for(let o=0;o<l;o++){const s=r[o%r.length];n.push({...s,id:o+1,question:`Question ${o+1} - ${null==(i=e.matiere)?void 0:i.name}`})}return n},le=async(e=!1)=>{if(!L)try{X(!0);const s=new Date,t=Math.floor((s-te)/1e3);let a=0,r=0,l=0;w.forEach(e=>{r+=e.points,A[e.id]===e.correct_answer&&(a++,l+=e.points)});const o=Math.round(l/r*100),d=w.map(e=>({question_id:e.id,question_text:e.question||e.text,user_answer:A[e.id]||null,correct_answer:e.correct_answer,is_correct:A[e.id]===e.correct_answer,topic:e.topic||e.subject||(null==j?void 0:j.title)||"Général",difficulty:e.difficulty||"moyen",points:e.points})),{data:c,error:m}=await n.from("exam_results").insert({user_id:f.id,exam_id:i,score:o,time_taken:t,answers:d,completed_at:(new Date).toISOString()}).select().single();if(m)throw m;const x=Math.floor(2*o),{error:h}=await n.rpc("add_user_points",{p_user_id:f.id,p_points:x,p_description:`Examen complété: ${j.title}`,p_category:"exam"});se({score:o,correctAnswers:a,totalQuestions:w.length,timeTaken:t,pointsEarned:x}),Z(!0),e||b({title:"✅ Examen terminé !",description:`Score: ${o}% - ${x} points gagnés`})}catch(s){b({variant:"destructive",title:"Erreur",description:"Impossible de sauvegarder vos résultats"})}finally{X(!1)}},ne=w[v],oe=(v+1)/w.length*100,de=Object.keys(A).length;if(W)return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center",children:s.jsx("div",{className:"text-white text-xl",children:"Chargement de l'examen..."})});if(Y&&ee){const e=ee.score>=50;return s.jsxs(s.Fragment,{children:[s.jsx(t,{children:s.jsxs("title",{children:["Résultats - ",j.title," - E-Réussite"]})}),s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4 sm:p-8",children:s.jsxs("div",{className:"max-w-4xl mx-auto",children:[s.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center mb-8",children:[e?s.jsx(_,{className:"w-20 h-20 text-green-400 mx-auto mb-4"}):s.jsx(k,{className:"w-20 h-20 text-red-400 mx-auto mb-4"}),s.jsx("h1",{className:"text-4xl font-bold text-white mb-2",children:e?"Félicitations !":"Continuez vos efforts !"}),s.jsx("p",{className:"text-xl text-blue-200",children:j.title})]}),s.jsx(o,{className:"bg-white/10 backdrop-blur-sm border-white/20 dark:border-white/30 mb-6 shadow-xl dark:shadow-[0_0_40px_rgba(255,255,255,0.5)]",children:s.jsxs(d,{className:"p-8",children:[s.jsxs("div",{className:"text-center mb-8",children:[s.jsxs("div",{className:"text-6xl font-bold text-white mb-2",children:[ee.score,"%"]}),s.jsx("p",{className:"text-blue-200 text-lg",children:"Score Final"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"text-center",children:[s.jsxs("div",{className:"text-3xl font-bold text-white mb-1",children:[ee.correctAnswers,"/",ee.totalQuestions]}),s.jsx("p",{className:"text-blue-200",children:"Réponses Correctes"})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-3xl font-bold text-white mb-1",children:(ce=ee.timeTaken,`${Math.floor(ce/60)}min ${ce%60}s`)}),s.jsx("p",{className:"text-blue-200",children:"Temps Écoulé"})]}),s.jsxs("div",{className:"text-center",children:[s.jsxs("div",{className:"text-3xl font-bold text-yellow-400 mb-1",children:["+",ee.pointsEarned]}),s.jsx("p",{className:"text-blue-200",children:"Points Gagnés"})]})]})]})}),j.pdf_url||j.correction_video_url?s.jsxs(o,{className:"bg-white/10 backdrop-blur-sm border-white/20 dark:border-white/30 mb-6 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:[s.jsx(c,{children:s.jsx(m,{className:"text-white",children:"Ressources Complémentaires"})}),s.jsxs(d,{className:"space-y-3",children:[j.pdf_url&&s.jsxs("a",{href:j.pdf_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-4 bg-white/5 rounded-lg hover:bg-white/10 transition",children:[s.jsx(S,{className:"w-6 h-6 text-blue-400"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-white font-medium",children:"Télécharger le PDF"}),s.jsx("p",{className:"text-sm text-gray-300",children:"Sujet complet de l'examen"})]})]}),j.correction_video_url&&s.jsxs("a",{href:j.correction_video_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-4 bg-white/5 rounded-lg hover:bg-white/10 transition",children:[s.jsx(C,{className:"w-6 h-6 text-purple-400"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-white font-medium",children:"Vidéo de Correction"}),s.jsx("p",{className:"text-sm text-gray-300",children:"Explication détaillée"})]})]})]})]}):null,s.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[s.jsx(x,{onClick:()=>p("/exam"),variant:"outline",className:"flex-1 bg-white/10 border-white/30 text-white hover:bg-white/20",children:"Retour aux examens"}),s.jsx(x,{onClick:()=>window.location.reload(),className:"flex-1 bg-blue-600 hover:bg-blue-700",children:"Refaire l'examen"}),s.jsx(x,{onClick:()=>p("/dashboard"),className:"flex-1 bg-green-600 hover:bg-green-700",children:"Tableau de bord"})]})]})})]})}var ce;return s.jsxs(s.Fragment,{children:[s.jsx(t,{children:s.jsxs("title",{children:[j.title," - E-Réussite"]})}),s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white p-4 sm:p-8",children:s.jsxs("div",{className:"max-w-5xl mx-auto",children:[s.jsxs("header",{className:"flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 bg-white/10 backdrop-blur-sm rounded-lg p-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:j.title}),s.jsx("p",{className:"text-blue-200 text-sm",children:null==(a=j.matiere)?void 0:a.name})]}),s.jsxs("div",{className:"flex items-center gap-3 px-6 py-3 rounded-lg "+(V<300?"bg-red-600/80 animate-pulse":"bg-blue-600/80"),children:[s.jsx(R,{className:"w-6 h-6"}),s.jsx("span",{className:"font-mono text-2xl font-bold",children:(e=>`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`)(V)})]})]}),s.jsx(o,{className:"bg-white/10 backdrop-blur-sm border-white/20 dark:border-white/30 mb-6 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsxs(d,{className:"p-4",children:[s.jsxs("div",{className:"flex justify-between text-sm text-blue-200 mb-2",children:[s.jsxs("span",{children:["Question ",v+1," sur ",w.length]}),s.jsxs("span",{children:[de," / ",w.length," réponses"]})]}),s.jsx(h,{value:oe,className:"h-2"})]})}),s.jsx(T,{mode:"wait",children:s.jsx(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.3},children:s.jsxs(o,{className:"bg-white/10 backdrop-blur-sm border-white/20 dark:border-white/30 mb-6 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:[s.jsx(c,{children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(m,{className:"text-white text-lg",children:null==ne?void 0:ne.question}),s.jsxs(u,{className:"bg-blue-600",children:[null==ne?void 0:ne.points," pts"]})]})}),s.jsxs(d,{className:"space-y-4",children:[s.jsx("p",{className:"text-gray-200 text-lg mb-6",children:null==ne?void 0:ne.text}),s.jsx("div",{className:"space-y-3",children:null==ne?void 0:ne.options.map(e=>{const t=A[ne.id]===e.id;return s.jsx("button",{onClick:()=>{return s=ne.id,t=e.id,void I(e=>({...e,[s]:t}));var s,t},className:"w-full text-left p-4 rounded-lg border-2 transition-all "+(t?"border-blue-500 bg-blue-500/20":"border-white/30 bg-white/5 hover:bg-white/10"),children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-6 h-6 rounded-full border-2 flex items-center justify-center "+(t?"border-blue-500 bg-blue-500":"border-white/50"),children:t&&s.jsx(_,{className:"w-4 h-4 text-white"})}),s.jsxs("span",{className:"text-white font-medium",children:[e.id.toUpperCase(),"."]}),s.jsx("span",{className:"text-gray-200",children:e.text})]})},e.id)})})]})]})},v)}),s.jsxs("div",{className:"flex justify-between items-center gap-4",children:[s.jsxs(x,{onClick:()=>y(e=>Math.max(0,e-1)),disabled:0===v,variant:"outline",className:"bg-white/10 border-white/30 text-white hover:bg-white/20 disabled:opacity-50",children:[s.jsx(q,{className:"w-5 h-5 mr-2"}),"Précédent"]}),v===w.length-1?s.jsxs(Q,{children:[s.jsx(z,{asChild:!0,children:s.jsx(x,{className:"bg-green-600 hover:bg-green-700",disabled:de<w.length,children:"Terminer l'examen"})}),s.jsxs(O,{children:[s.jsxs(F,{children:[s.jsx(B,{children:"Terminer l'examen ?"}),s.jsxs(H,{children:["Vous avez répondu à ",de," sur ",w.length," questions.",de<w.length&&s.jsxs("span",{className:"text-yellow-600 block mt-2",children:["⚠️ Il reste ",w.length-de," question(s) sans réponse."]}),s.jsx("br",{}),"Une fois terminé, vous ne pourrez plus modifier vos réponses."]})]}),s.jsxs(P,{children:[s.jsx(G,{children:"Annuler"}),s.jsx(U,{onClick:()=>le(!1),children:"Confirmer et terminer"})]})]})]}):s.jsxs(x,{onClick:()=>y(e=>Math.min(w.length-1,e+1)),className:"bg-blue-600 hover:bg-blue-700",children:["Suivant",s.jsx(E,{className:"w-5 h-5 ml-2"})]})]})]})})]})};export{V as default};
