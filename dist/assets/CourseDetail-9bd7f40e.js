import{r as e,j as s}from"./vendor-react-470eca1f.js";import{H as t}from"./Helmet-2c7e73f6.js";import{N as a}from"./Navbar-fef78110.js";import{S as r}from"./ShareButton-304bb343.js";import{e as i,u as l,B as n,C as c,a as o,b as d,c as m,i as x}from"./index-80385b81.js";import{P as h}from"./progress-d9418a6f.js";import{B as p}from"./badge-3c6eba89.js";import{d as u,c as j}from"./vendor-router-da2b77bd.js";import{aR as g,X as v,M as f,c as b,J as N,g as w,ap as y,aJ as _,aS as k,C,n as S,a7 as $}from"./vendor-ui-297a683c.js";import{A as E,m as T}from"./vendor-charts-0ffd78b1.js";import"./vendor-supabase-1d8f37f5.js";const z=()=>{var z,B;const{matiereId:M}=u(),I=j(),{user:L}=i(),{toast:P}=l(),[F,R]=e.useState(null),[D,q]=e.useState(null),[H,U]=e.useState(null),[V,J]=e.useState([]),[O,W]=e.useState(!0),[A,G]=e.useState(!0),[K,Q]=e.useState(!1);e.useEffect(()=>{M&&(async()=>{var e,s;W(!0);try{const{data:t,error:a}=await x.course.getMatiereById(M);if(a)throw a;if(R(t),L){const{data:e}=await x.progress.getUserProgress(L.id);J(e||[])}if((null==(e=null==t?void 0:t.chapitres)?void 0:e.length)>0){const e=t.chapitres[0];(null==(s=e.lecons)?void 0:s.length)>0&&q(e.lecons[0].id)}}catch(t){P({title:"Erreur",description:"Impossible de charger le cours.",variant:"destructive"})}finally{W(!1)}})()},[M,L]),e.useEffect(()=>{(async()=>{if(D)try{const{data:e,error:s}=await x.course.getLecon(D);if(s)throw s;U(e)}catch(e){}})()},[D]);const X=(null==F?void 0:F.chapitres)?F.chapitres.sort((e,s)=>e.order-s.order).flatMap(e=>(e.lecons||[]).sort((e,s)=>e.order-s.order).map(s=>({...s,chapitre_title:e.title,chapitre_id:e.id}))):[],Y=X.findIndex(e=>e.id===D),Z=Y<X.length-1,ee=Y>0,se=()=>{Z&&(q(X[Y+1].id),window.scrollTo(0,0))},te=e=>V.some(s=>s.lecon_id===e);if(O)return s.jsx("div",{className:"min-h-screen bg-white flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),s.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Chargement du cours..."})]})});if(!F)return s.jsxs("div",{className:"min-h-screen bg-white",children:[s.jsx(a,{}),s.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-20 text-center",children:[s.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-4",children:"Cours introuvable"}),s.jsx(n,{onClick:()=>I("/my-courses"),children:"Retour aux cours"})]})]});const ae=(()=>{if(0===X.length)return 0;const e=X.filter(e=>te(e.id)).length;return Math.round(e/X.length*100)})();return s.jsxs(s.Fragment,{children:[s.jsxs(t,{children:[s.jsxs("title",{children:[F.name," - Cours d√©taill√© | E-R√©ussite"]}),s.jsx("meta",{name:"description",content:`Cours complet de ${F.name} avec le√ßons, exercices et quiz`})]}),s.jsxs("div",{className:"min-h-screen bg-slate-50",children:[s.jsx(a,{}),s.jsx("div",{className:"bg-gradient-to-r from-primary to-accent text-white py-8 mt-16",children:s.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(n,{variant:"ghost",onClick:()=>I("/my-courses"),className:"text-white hover:bg-white/20",children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"Retour aux cours"]}),s.jsx(r,{url:window.location.href,title:`Cours de ${F.name}`,description:`Cours complet de ${F.name} niveau ${"bfem"===F.level?"BFEM":"Baccalaur√©at"} - ${X.length} le√ßons`,type:"course",resourceId:M,options:{tags:[F.level,"cours",F.slug]},variant:"ghost",buttonText:"Partager",className:"text-white hover:bg-white/20"})]}),s.jsx(n,{variant:"ghost",onClick:()=>G(!A),className:"text-white hover:bg-white/20 lg:hidden",children:A?s.jsx(v,{className:"w-5 h-5"}):s.jsx(f,{className:"w-5 h-5"})})]}),s.jsx("h1",{className:"text-3xl md:text-4xl font-bold mb-2",children:F.name}),s.jsxs("p",{className:"text-white/90 mb-4",children:["Niveau : ","bfem"===F.level?"BFEM":"Baccalaur√©at"]}),s.jsxs("div",{className:"flex items-center gap-6 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(b,{className:"w-4 h-4"}),s.jsxs("span",{children:[X.length," le√ßons"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N,{className:"w-4 h-4"}),s.jsxs("span",{children:[15*X.length," min"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(w,{className:"w-4 h-4"}),s.jsxs("span",{children:[ae,"% compl√©t√©"]})]})]}),s.jsx("div",{className:"mt-4",children:s.jsx(h,{value:ae,className:"h-2 bg-white/20"})})]})}),s.jsx("div",{className:"max-w-7xl mx-auto px-4 py-8",children:s.jsxs("div",{className:"grid lg:grid-cols-4 gap-8",children:[s.jsx(E,{children:(A||window.innerWidth>=1024)&&s.jsx(T.aside,{initial:{x:-300,opacity:0},animate:{x:0,opacity:1},exit:{x:-300,opacity:0},className:"lg:col-span-1 fixed lg:relative inset-0 lg:inset-auto z-40 lg:z-0 bg-white lg:bg-transparent",children:s.jsxs(c,{className:"sticky top-24 max-h-[calc(100vh-120px)] overflow-y-auto dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:[s.jsx(o,{children:s.jsxs(d,{className:"text-lg flex items-center justify-between",children:["Programme",s.jsx(n,{variant:"ghost",size:"sm",onClick:()=>G(!1),className:"lg:hidden",children:s.jsx(v,{className:"w-4 h-4"})})]})}),s.jsx(m,{className:"space-y-1",children:null==(z=F.chapitres)?void 0:z.map(e=>{var t;return s.jsxs("div",{className:"mb-4",children:[s.jsx("h3",{className:"font-semibold text-sm text-slate-700 dark:text-slate-200 mb-2 px-2",children:e.title}),null==(t=e.lecons)?void 0:t.map((e,t)=>{const a=e.id===D,r=te(e.id),i=!e.is_free_preview&&!L;return s.jsxs("button",{onClick:()=>!i&&q(e.id),disabled:i,className:`\n                                  w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center gap-2\n                                  ${a?"bg-primary text-white":"hover:bg-slate-100"}\n                                  ${i?"opacity-50 cursor-not-allowed":"cursor-pointer"}\n                                `,children:[r?s.jsx(y,{className:"w-4 h-4 text-green-500 flex-shrink-0"}):i?s.jsx(_,{className:"w-4 h-4 flex-shrink-0"}):s.jsx(k,{className:"w-4 h-4 flex-shrink-0"}),s.jsxs("span",{className:"flex-1 truncate",children:[t+1,". ",e.title]}),e.is_free_preview&&s.jsx(p,{variant:"outline",className:"text-xs",children:"Gratuit"})]},e.id)})]},e.id)})})]})})}),s.jsx("div",{className:"lg:col-span-3",children:s.jsx(c,{className:"dark:bg-slate-800 dark:border-white/20 border-2 shadow-lg dark:shadow-[0_0_30px_rgba(255,255,255,0.4)]",children:s.jsx(m,{className:"p-8",children:H?s.jsxs(T.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500 mb-2",children:[s.jsx("span",{children:null==(B=H.chapitre)?void 0:B.title}),s.jsx(C,{className:"w-4 h-4"}),s.jsxs("span",{children:["Le√ßon ",Y+1," / ",X.length]})]}),s.jsx("h1",{className:"text-3xl font-bold text-slate-900 dark:text-white mb-4",children:H.title}),te(D)&&s.jsxs(p,{className:"bg-green-500",children:[s.jsx(y,{className:"w-3 h-3 mr-1"}),"Compl√©t√©"]})]}),H.video_url&&s.jsx("div",{className:"mb-6 rounded-lg overflow-hidden bg-slate-900 aspect-video",children:s.jsx("video",{controls:!0,className:"w-full h-full",src:H.video_url,children:"Votre navigateur ne supporte pas la lecture de vid√©os."})}),s.jsx("div",{className:"prose max-w-none mb-8",children:H.content?s.jsx("div",{dangerouslySetInnerHTML:{__html:H.content}}):s.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Le contenu de cette le√ßon sera bient√¥t disponible."})}),H.pdf_url&&s.jsxs("div",{className:"mb-6 p-4 bg-slate-50 rounded-lg flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(S,{className:"w-5 h-5 text-primary"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"Document PDF"}),s.jsx("p",{className:"text-sm text-slate-500",children:"Support de cours"})]})]}),s.jsxs(n,{variant:"outline",onClick:()=>window.open(H.pdf_url,"_blank"),children:[s.jsx($,{className:"w-4 h-4 mr-2"}),"T√©l√©charger"]})]}),!te(D)&&L&&s.jsx("div",{className:"mb-6",children:s.jsx(n,{onClick:async()=>{if(L)if(te(D))P({title:"D√©j√† compl√©t√©",description:"Vous avez d√©j√† termin√© cette le√ßon."});else{Q(!0);try{const{data:e,error:s}=await x.progress.completeLecon(L.id,D);if(s)throw s;J(e=>[...e,{lecon_id:D,user_id:L.id}]);const t=null==e?void 0:e.points;if(t){const{points_earned:e,chapter_bonus:s,course_bonus:a,total_points:r,chapter_completed:i,course_completed:l,badges_unlocked:n,challenges_updated:c}=t;let o=`+${e} points pour la le√ßon`;if(s>0&&(o+=` | üéØ +${s} pts (chapitre complet !)`),a>0&&(o+=` | üèÜ +${a} pts (COURS COMPLET !)`),P({title:`‚úÖ +${r} points !`,description:o,duration:i||l?5e3:3e3}),n&&n.length>0&&n.forEach((e,s)=>{setTimeout(()=>{P({title:"üèÖ Badge d√©bloqu√© !",description:`${e.icon} ${e.name}`,duration:5e3})},1500*(s+1))}),c&&c.length>0){const e=c.filter(e=>e.completed),s=n?1500*n.length:0;e.forEach((e,t)=>{setTimeout(()=>{P({title:"üéØ D√©fi compl√©t√© !",description:`${e.icon} ${e.name} - R√©clamez votre r√©compense dans la page D√©fis !`,duration:6e3})},s+1500*(t+1))})}}else P({title:"‚úÖ Le√ßon termin√©e !",description:"Continuez comme √ßa !"});setTimeout(()=>{Z&&se()},1500)}catch(e){P({title:"Erreur",description:"Impossible de sauvegarder votre progression.",variant:"destructive"})}finally{Q(!1)}}else P({title:"Connexion requise",description:"Veuillez vous connecter pour sauvegarder votre progression."})},disabled:K,className:"w-full bg-green-600 hover:bg-green-700",children:K?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Enregistrement..."]}):s.jsxs(s.Fragment,{children:[s.jsx(y,{className:"w-4 h-4 mr-2"}),"Marquer comme compl√©t√©"]})})}),s.jsxs("div",{className:"flex items-center justify-between pt-6 border-t",children:[s.jsxs(n,{variant:"outline",onClick:()=>{ee&&(q(X[Y-1].id),window.scrollTo(0,0))},disabled:!ee,children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"Pr√©c√©dent"]}),s.jsxs(n,{onClick:se,disabled:!Z,className:"bg-primary",children:["Suivant",s.jsx(C,{className:"w-4 h-4 ml-2"})]})]})]},D):s.jsx("div",{className:"text-center py-12",children:s.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"S√©lectionnez une le√ßon pour commencer"})})})})})]})})]})]})};export{z as default};
